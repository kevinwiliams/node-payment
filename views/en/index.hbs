<!-- Step 1: Introduction Page -->
<div class="container py-2">
  <div class="row justify-content-center">
    <div class="col-md-8">
   
      <form id="step1Form" class="pb-5" method="post" action="/en/checkout">
           <div class="">
        <div class="section-title">
          <h2>Please select a payment category below</h2>
        </div>
      </div>
        <div class="mb-3 py-1">
          <select class="form-select" id="category" name="category" required>
            <option value="" selected>Select Service</option>
             {{#each categories}}
                <option value="{{ this.dataValues.categoryId }}">{{ this.dataValues.name }}</option>
            {{/each}}
          </select>
          
        </div>
        <input id="categoryName" name="categoryName" type="hidden">
          <input id="currencyhd" name="currencyhd" type="hidden" />
            <input id="otherInfohd" name="otherInfo" type="hidden" />

        <div id="categoryList" class="mb-3 py-3" style="display: none;">
            <div class="section-title">
          <h2>Please select the service you want to pay for</h2>
            <input id="serviceText" name="serviceText" type="hidden" />
            <input id="description" name="description" type="hidden" />
            

        </div>
            <div id="serviceOptions"></div>
        </div>
        <button type="submit" class="btn btn-danger" >Next Step</button>
      </form>
    </div>
  </div>
</div>
  <!-- Scripts -->
<script src="/assets/js/jquery-3.7.1.min.js"></script>
  <script>
    // Function to create radio button and associated elements
    function createRadioButton(index, service) {
        // Create radio button
        var radioButton = document.createElement('input');
        radioButton.type = 'radio';
        radioButton.name = 'service';
        radioButton.dataset.text = service.name;
        radioButton.dataset.desc = service.description;
        radioButton.id = 'service' + index;
        radioButton.value = service.serviceId;
        radioButton.classList.add('form-check-input');

        // Create label for the radio button
        var label = document.createElement('label');
        label.setAttribute('for', 'service' + index);
        label.textContent = service.name;

        // Create div to contain the radio button and associated elements
        var div = document.createElement('div');
        div.classList.add('form-check');
        div.classList.add('pb-3');
        div.appendChild(radioButton);
        div.appendChild(label);

        // Add event listener to radio button to toggle visibility of price and textarea
        radioButton.addEventListener('change', function() {
            var allRadioButtons = document.querySelectorAll('input[name="service"]');
            allRadioButtons.forEach(function(radio) {
                var parentDiv = radio.parentNode;
                var priceInput = parentDiv.querySelector('input[name="price"]');
                var currencyList = parentDiv.querySelector('select[name="currency"]');
                var notesText = parentDiv.querySelector('textarea[name="otherInfo"]');
                if (radio.checked) {
                    console.log(radio.dataset.text);
                    $('#serviceText').val(radio.dataset.text);
                    $('#description').val(radio.dataset.desc);

                    // Show price input and textarea for the selected radio button
                    if (currencyList) currencyList.style.display = 'block';
                    if (priceInput) priceInput.style.display = 'block';
                    if (notesText) notesText.style.display = 'block';
                } else {
                    // Hide price input and textarea for other radio buttons
                    if (currencyList) currencyList.style.display = 'none';
                    if (priceInput) priceInput.style.display = 'none';
                    if (notesText) notesText.style.display = 'none';
                }
            });
        });

        // Create hidden input fields for additional data
        var hdPriceInput = document.createElement('input');
        hdPriceInput.type = 'hidden';
        hdPriceInput.name = 'pricehd';
        hdPriceInput.value = service.price;
        div.appendChild(hdPriceInput);

        // If price is 0, create an input box to collect the price
        if (service.price !== null && service.price !== 0) {
            var priceSpan = document.createElement('span');
            priceSpan.classList.add('px-3');
            priceSpan.textContent = service.currency + ' $' + service.price; // Display price and currency
            div.appendChild(priceSpan); // Append the price information to the div
        } else {

            var priceInputGroup = document.createElement('div');
            priceInputGroup.classList.add('input-group');
            priceInputGroup.classList.add('d-flex');
            priceInputGroup.classList.add('mb-2');

            var currencyDropdown = document.createElement('select');
            currencyDropdown.name = 'currency';
            currencyDropdown.classList.add('form-control');
            currencyDropdown.classList.add('me-1');
            currencyDropdown.classList.add('w-10');
            currencyDropdown.style.display = 'none'; // Hide dropdown initially
            var jmdOption = new Option('JMD', 'JMD');
            var usdOption = new Option('USD', 'USD');
            currencyDropdown.appendChild(jmdOption);
            currencyDropdown.appendChild(usdOption);
            //div.appendChild(currencyDropdown);
            priceInputGroup.appendChild(currencyDropdown);

            var priceInput = document.createElement('input');
            priceInput.type = 'number';
            priceInput.name = 'price';
            priceInput.placeholder = 'Enter Price';
            priceInput.classList.add('form-control');
            priceInput.classList.add('flex-grow-1');
            priceInput.style.display = 'none'; // Hide price input initially
            //div.appendChild(priceInput);
            priceInputGroup.appendChild(priceInput);
            div.appendChild(priceInputGroup);

            var notesText = document.createElement('textarea');
            notesText.name = 'otherInfo';
            notesText.rows = '3';
            notesText.placeholder = 'Enter additional notes re your payment';
            notesText.classList.add('form-control');
            notesText.style.display = 'none'; // Hide textarea initially
            div.appendChild(notesText);
        }

        // var addBreak = document.createElement('br');
        // div.appendChild(addBreak);

        var descriptionInput = document.createElement('span');
        descriptionInput.name = 'description';
        descriptionInput.innerHTML = service.description; 
        descriptionInput.classList.add('row'); 
        descriptionInput.classList.add('px-2'); 
        descriptionInput.classList.add('small'); 
        descriptionInput.classList.add('text-secondary'); 
        div.appendChild(descriptionInput);

        return div;
    }
    // Function to append radio buttons to the serviceOptions div
    function appendRadioButtons(services) {
        var serviceOptions = document.getElementById('serviceOptions');
        serviceOptions.innerHTML = ''; // Clear previous content

        services.forEach(function(service, index) {
            var radioButtonDiv = createRadioButton(index, service);
            serviceOptions.appendChild(radioButtonDiv);
        });
    }

    $(document).ready(function() {

        $(window).on('pageshow', function (event) {
            // Check if the event's persisted property is false
            if (event.originalEvent.persisted) {
                // This means the page is loaded from the cache
                $('#category').val('').trigger('change');
            }
        });

        $('#category').val('').trigger('change');
        $('#category').on('change', function() {
            var categoryId = $(this).val();
            var categoryName = $(this).find('option:selected').text();
            console.log('categoryId', categoryId);
            console.log('categoryName', categoryName);
            $('#categoryName').val(categoryName);

            if(!categoryId){
                $('#categoryList').hide();
            }

            $.ajax({
            url: '/en/service',
            method: 'POST',
            data: { id: categoryId },
            success: function(response) {
                // Clear existing service options
                $('#serviceOptions').empty();
                // Append radio buttons for each service
                appendRadioButtons(response.services);
                // Show the services
                $('#categoryList').show();
            },
            error: function(err) {
                console.error(err);
                alert('Error loading services');
            }
        });
        });
        $('#step1Form').on('submit', function(event) {
            event.preventDefault(); // Prevent the default form submission
            
            // Find the selected radio button
            var selectedService = $('input[name="service"]:checked');
                    
            // If no service is selected, display an error message and stop the submission
            if (!selectedService.length) {
                alert('Please select a service');
                return;
            }
                    
            // Retrieve the selected service details
            var serviceName = selectedService.data('text');
            var serviceDesc = selectedService.data('desc');
            
            // Assign the selected service details to hidden fields
            $('#serviceText').val(serviceName);
            $('#description').val(serviceDesc);

            // Retrieve the hidden field values
            var currency = selectedService.closest('div').find('input[name="currency"]').val();
            var price = selectedService.closest('div').find('input[name="price"]').val();
            var otherInfo = selectedService.closest('div').find('input[name="otherInfo"]').val();

            // Assign the hidden field values to hidden input fields in the form
            $('#currencyhd').val(currency);
            $('#pricehd').val(price);
            $('#otherInfohd').val(otherInfo);

            console.log('currency', currency);
            console.log('price', price);
            console.log('otherInfo', otherInfo);
            // Submit the form
            this.submit();
        });
    
    });

  </script>